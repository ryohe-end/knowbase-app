version: 1
frontend:
  phases:
    preBuild:
      commands:
        - |
          npm ci

        - |
          # ✅ runtime-env.txt を生成（全部 1行 key=value）
          {
            echo "TEMPLATE_FILE_ID=$TEMPLATE_FILE_ID"
            echo "TEMPLATE_COPY_PARENT_FOLDER_ID=$TEMPLATE_COPY_PARENT_FOLDER_ID"
          } > runtime-env.txt

        - |
          # SA JSON を1行化して key=value で追記（改行は \n に）
          SA_ESCAPED="$(node -e 'const v=process.env.GOOGLE_SERVICE_ACCOUNT_JSON||""; process.stdout.write(v.replace(/\r?\n/g,"\\\\n"))')"
          printf 'GOOGLE_SERVICE_ACCOUNT_JSON=%s\n' "$SA_ESCAPED" >> runtime-env.txt

        - |
          # ✅ ここで空ならビルド失敗（値は出さない）
          node -e 'process.exit(process.env.TEMPLATE_FILE_ID?0:2)' || (echo "ERROR: TEMPLATE_FILE_ID missing" && exit 1)
          node -e 'process.exit(process.env.GOOGLE_SERVICE_ACCOUNT_JSON?0:2)' || (echo "ERROR: GOOGLE_SERVICE_ACCOUNT_JSON missing" && exit 1)

    build:
      commands:
        - |
          npm run build

        - |
          # ✅ 実行環境が読める場所へ同梱（ドット無しファイル）
          mkdir -p .next/server
          cp runtime-env.txt .next/server/runtime-env.txt

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"

  cache:
    paths:
      - node_modules/**/*
