version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - |
          # ✅ 環境変数を runtime-env.txt に書き出す
          {
            echo "TEMPLATE_FILE_ID=$TEMPLATE_FILE_ID"
            echo "TEMPLATE_COPY_PARENT_FOLDER_ID=$TEMPLATE_COPY_PARENT_FOLDER_ID"
          } > runtime-env.txt
        - |
          # ✅ SA JSON を 1 行化（構文エラーを修正した確実な形式）
          SA_VAL="${GOOGLE_SERVICE_ACCOUNT_JSON:-}"
          node -e "const s=process.env.SA_VAL||''; process.stdout.write('GOOGLE_SERVICE_ACCOUNT_JSON=' + s.replace(/\r?\n/g, '\\\\n') + '\n')" SA_VAL="$SA_VAL" >> runtime-env.txt
        - |
          # ✅ 設定チェック
          node -e "process.exit(process.env.TEMPLATE_FILE_ID ? 0 : 2)" || (echo "ERROR: TEMPLATE_FILE_ID missing" && exit 1)
    build:
      commands:
        - npm run build
        - |
          # ✅ 実行環境へコピー
          mkdir -p .next/server
          cp runtime-env.txt .next/server/runtime-env.txt
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
